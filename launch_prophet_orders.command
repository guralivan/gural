#!/bin/bash

echo "üîÆ –ó–∞–ø—É—Å–∫ Prophet –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤..."
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Python3
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.8+ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi
echo "‚úÖ Python3 –Ω–∞–π–¥–µ–Ω: $(python3 --version)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ pip3
if ! command -v pip3 &> /dev/null; then
    echo "‚ùå pip3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pip –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi
echo "‚úÖ pip3 –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö
if [ ! -f "45.xlsx" ]; then
    echo "‚ùå –§–∞–π–ª 45.xlsx –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª 45.xlsx –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ —Å–∫—Ä–∏–ø—Ç"
    exit 1
fi
echo "‚úÖ –§–∞–π–ª 45.xlsx –Ω–∞–π–¥–µ–Ω"

# –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -d "venv_prophet_orders" ]; then
    echo "üì¶ –°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    python3 -m venv venv_prophet_orders
fi

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "üîß –ê–∫—Ç–∏–≤–∏—Ä—É—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
source venv_prophet_orders/bin/activate

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üìö –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install -r requirements_prophet_orders.txt

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é —É—Å—Ç–∞–Ω–æ–≤–∫—É..."
python3 -c "import streamlit, pandas, numpy, plotly, openpyxl, prophet; print('‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã')"

if [ $? -eq 0 ]; then
    echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞ 45.xlsx..."
    python3 -c "
import pandas as pd
try:
    df = pd.read_excel('45.xlsx', sheet_name='–¢–æ–≤–∞—Ä—ã', header=1)
    print(f'‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ: {len(df)} –∑–∞–ø–∏—Å–µ–π')
    print(f'üìä –°—Ç–æ–ª–±—Ü—ã: {len(df.columns)}')
    if '–î–∞—Ç–∞' in df.columns:
        print('‚úÖ –°—Ç–æ–ª–±–µ—Ü \"–î–∞—Ç–∞\" –Ω–∞–π–¥–µ–Ω')
    else:
        print('‚ùå –°—Ç–æ–ª–±–µ—Ü \"–î–∞—Ç–∞\" –Ω–µ –Ω–∞–π–¥–µ–Ω')
    if '–ó–∞–∫–∞–∑–∞–ª–∏, —à—Ç' in df.columns:
        print('‚úÖ –°—Ç–æ–ª–±–µ—Ü \"–ó–∞–∫–∞–∑–∞–ª–∏, —à—Ç\" –Ω–∞–π–¥–µ–Ω')
    else:
        print('‚ùå –°—Ç–æ–ª–±–µ—Ü \"–ó–∞–∫–∞–∑–∞–ª–∏, —à—Ç\" –Ω–µ –Ω–∞–π–¥–µ–Ω')
    
    # –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    df['–î–∞—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞'])
    df['–û–±—â–∏–µ –∑–∞–∫–∞–∑—ã'] = df['–ó–∞–∫–∞–∑–∞–ª–∏, —à—Ç'].fillna(0) + df.get('–ó–∞–∫–∞–∑–∞–ª–∏ –í–ë –∫–ª—É–±, —à—Ç', 0).fillna(0)
    orders_data = df.groupby('–î–∞—Ç–∞')['–û–±—â–∏–µ –∑–∞–∫–∞–∑—ã'].sum().reset_index()
    print(f'üìà –î–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏: {len(orders_data)}')
    print(f'üìä –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤: {orders_data[\"–û–±—â–∏–µ –∑–∞–∫–∞–∑—ã\"].sum():,.0f}')
    print(f'üìä –°—Ä–µ–¥–Ω–µ–µ –∑–∞–∫–∞–∑–æ–≤ –≤ –¥–µ–Ω—å: {orders_data[\"–û–±—â–∏–µ –∑–∞–∫–∞–∑—ã\"].mean():.1f}')
    
except Exception as e:
    print(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–∞: {e}')
    exit(1)
"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é Prophet –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤..."
    echo "üì± –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: http://localhost:8514"
    echo "‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
    echo "=================================================="
    
    streamlit run app_prophet_orders.py --server.port 8514 --server.headless true
else
    echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    exit 1
fi

echo "üëã –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
