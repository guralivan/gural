import pandas as pd
import os

def debug_2025_issue():
    """–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞ 2025 –≥–æ–¥"""
    try:
        filename = '3_combined_2024_2025.xlsx'
        
        if not os.path.exists(filename):
            print(f"‚ùå –§–∞–π–ª {filename} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            return
        
        print(f"üìÅ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª {filename}...")
        df = pd.read_excel(filename)
        
        print(f"üìä –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: {len(df)}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–æ–Ω–∫–∏
        print(f"üìã –ö–æ–ª–æ–Ω–∫–∏: {list(df.columns)}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ
        if '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ' in df.columns:
            legal_entities = df['–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ'].unique()
            print(f"üè¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ª–∏—Ü–∞ –≤ —Ñ–∞–π–ª–µ: {legal_entities}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Æ–õ
            for entity in legal_entities:
                print(f"\nüîç –ê–Ω–∞–ª–∏–∑ –¥–ª—è: {entity}")
                entity_data = df[df['–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ'] == entity].copy()
                print(f"üìä –ó–∞–ø–∏—Å–µ–π –¥–ª—è —ç—Ç–æ–≥–æ –Æ–õ: {len(entity_data)}")
                
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã
                entity_data['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'] = pd.to_datetime(entity_data['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'], errors='coerce')
                entity_data['–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞'] = pd.to_datetime(entity_data['–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞'], errors='coerce')
                
                # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞—Ç–∞–º–∏
                entity_data_clean = entity_data.dropna(subset=['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞'])
                print(f"üìä –ó–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –¥–∞—Ç: {len(entity_data_clean)}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≥–æ–¥–∞–º
                records_2024 = len(entity_data_clean[entity_data_clean['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'].dt.year == 2024])
                records_2025 = len(entity_data_clean[entity_data_clean['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'].dt.year == 2025])
                
                print(f"üìà 2024 –≥–æ–¥: {records_2024} –∑–∞–ø–∏—Å–µ–π")
                print(f"üìà 2025 –≥–æ–¥: {records_2025} –∑–∞–ø–∏—Å–µ–π")
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
                min_date = entity_data_clean['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'].min()
                max_date = entity_data_clean['–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞'].max()
                print(f"üìÖ –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç: —Å {min_date.strftime('%d.%m.%Y')} –ø–æ {max_date.strftime('%d.%m.%Y')}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ 2025 –≥–æ–¥ –¥–µ—Ç–∞–ª—å–Ω–æ
                if records_2025 > 0:
                    data_2025 = entity_data_clean[entity_data_clean['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'].dt.year == 2025]
                    print(f"‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞ 2025 –≥–æ–¥ –Ω–∞–π–¥–µ–Ω—ã!")
                    print(f"üìÖ –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å 2025: {data_2025['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'].min().strftime('%d.%m.%Y')}")
                    print(f"üìÖ –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å 2025: {data_2025['–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞'].max().strftime('%d.%m.%Y')}")
                    
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤
                    print("\nüìã –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π –∑–∞ 2025 –≥–æ–¥:")
                    print(data_2025[['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞', '–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ']].head())
                else:
                    print("‚ùå –î–∞–Ω–Ω—ã–µ –∑–∞ 2025 –≥–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å–∏ —Å –¥–∞—Ç–∞–º–∏ 2025 –≥–æ–¥–∞
                    all_2025_records = entity_data_clean[entity_data_clean['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'].dt.year == 2025]
                    print(f"üîç –ó–∞–ø–∏—Å–µ–π —Å –¥–∞—Ç–∞–º–∏ 2025 –≥–æ–¥–∞: {len(all_2025_records)}")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–æ–¥—ã
                    years = sorted(entity_data_clean['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'].dt.year.unique())
                    print(f"üìÖ –ì–æ–¥—ã –≤ –¥–∞–Ω–Ω—ã—Ö: {years}")
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–º–µ–Ω—É –Ω–∞–∑–≤–∞–Ω–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞
        print(f"\nüîß –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–º–µ–Ω—É –Ω–∞–∑–≤–∞–Ω–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞...")
        df_test = df.copy()
        if '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ' in df_test.columns:
            df_test['–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ'] = df_test['–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ'].replace('–ì—É—Ä–∞–ª—å –ò–≤–∞–Ω –°–µ—Ä–≥–µ–µ–≤–∏—á –ò–ü', '–ò–ü –ì—É—Ä–∞–ª—å –î. –î.')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã
            ip_data = df_test[df_test['–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ'] == '–ò–ü –ì—É—Ä–∞–ª—å –î. –î.'].copy()
            print(f"üìä –ó–∞–ø–∏—Å–µ–π –¥–ª—è '–ò–ü –ì—É—Ä–∞–ª—å –î. –î.' –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã: {len(ip_data)}")
            
            if len(ip_data) > 0:
                ip_data['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'] = pd.to_datetime(ip_data['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'], errors='coerce')
                ip_data['–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞'] = pd.to_datetime(ip_data['–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞'], errors='coerce')
                ip_data_clean = ip_data.dropna(subset=['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞'])
                
                records_2024_ip = len(ip_data_clean[ip_data_clean['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'].dt.year == 2024])
                records_2025_ip = len(ip_data_clean[ip_data_clean['–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'].dt.year == 2025])
                
                print(f"üìà 2024 –≥–æ–¥ –¥–ª—è –ò–ü –ì—É—Ä–∞–ª—å –î. –î.: {records_2024_ip} –∑–∞–ø–∏—Å–µ–π")
                print(f"üìà 2025 –≥–æ–¥ –¥–ª—è –ò–ü –ì—É—Ä–∞–ª—å –î. –î.: {records_2025_ip} –∑–∞–ø–∏—Å–µ–π")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        print(f"–î–µ—Ç–∞–ª–∏: {traceback.format_exc()}")

if __name__ == "__main__":
    debug_2025_issue()
